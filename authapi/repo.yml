---
- name: AuthApi,  Downloading the project
  sudo: true
  sudo_user: authapi
  git: repo={{ repos.authapi.repo }} version={{ repos.authapi.version }}
       dest=/home/authapi/authapi

- name: AuthApi,  Creating the virtualenv
  sudo: true
  sudo_user: authapi
  shell: virtualenv -p /usr/bin/python3 /home/authapi/env

- name: AuthApi,  Installing python pacakges
  sudo: true
  sudo_user: authapi
  shell: /home/authapi/env/bin/pip install -r /home/authapi/authapi/requirements.txt

- name: AuthApi,  Installing python uwsgi, psycopg2
  sudo: true
  sudo_user: authapi
  shell: /home/authapi/env/bin/pip install uwsgi psycopg2

- name: AuthApi,  Creating deploy settings
  sudo: true
  template: src=authapi/templates/deploy.py dest=/home/authapi/authapi/authapi/authapi owner=authapi mode=0644

- name: AuthApi,  Migrate
  sudo: true
  sudo_user: authapi
  django_manage: command=migrate
  args:
    app_path: /home/authapi/authapi/authapi
    virtualenv: /home/authapi/env
    settings: "authapi.deploy"

- name: AuthApi, Creates webstatic directory
  sudo: true
  sudo_user: authapi
  file: path=/home/authapi/webstatic state=directory

- name: AuthApi, Collect static
  sudo: true
  sudo_user: authapi
  django_manage: command=collectstatic
  args:
    app_path: /home/authapi/authapi/authapi
    virtualenv: /home/authapi/env
    settings: "authapi.deploy"

- name: AuthApi,  Creating uwsgi settings
  sudo: true
  template: src=authapi/templates/uwsgi.ini dest=/home/authapi/uwsgi.ini owner=authapi mode=0644

- name: AuthApi,  Admin user
  sudo: true
  template: src=authapi/templates/admin.json dest=/home/authapi/admin.json owner=authapi mode=0644

- name: AuthApi,  Admin user (2)
  sudo: true
  sudo_user: authapi
  django_manage: command=loaddata fixtures=/home/authapi/admin.json
  args:
    app_path: /home/authapi/authapi/authapi
    virtualenv: /home/authapi/env
    settings: "authapi.deploy"
